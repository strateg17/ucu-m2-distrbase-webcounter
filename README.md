# Web Counter Performance

Цей репозиторій містить простий FastAPI-сервіс з двома ендпоінтами:

- `GET /inc` — потокобезпечний інкремент лічильника.
- `GET /count` — повертає поточне значення лічильника.

Сховище лічильника можна перемикати між оперативною пам'яттю та файловою системою змінною оточення `STORAGE_MODE` (`memory` або `file`). 
Для файлового режиму шлях до файлу задається `COUNTER_FILE` (за замовчуванням `./data/counter.txt`).

## Вимоги

- Python 3.11+
- Залежності з `requirements.txt`

```bash
pip install -r requirements.txt
```

## Запуск сервера

```bash
# ОЗУ режим (за замовчуванням)
uvicorn server:app --host 0.0.0.0 --port 8080

# Файловий режим
STORAGE_MODE=file COUNTER_FILE=./data/counter.txt uvicorn server:app --host 0.0.0.0 --port 8080
```

## Клієнт для навантаження

Скрипт `client.py` запускає декілька потоків і робить вказану кількість запитів до `/inc`, вимірюючи загальний час виконання та обраховуючи throughput.

```bash
python client.py http://localhost:8080 --clients 5 --requests-per-client 10000
```

У виході буде надруковано:

```
clients=5 requests_per_client=10000 total_requests=50000 elapsed=2.345s throughput=21314.61rps count=50000
```

`count` показує фактичне значення на сервері після навантаження.

## Перед початком вимірювань

1. **Почистити стан**: перед новою серією тестів видаліть файл лічильника або перезапустіть сервер, щоб значення починалось з нуля.
2. **Паралельний старт клієнтів**: усі потоки стартують одночасно за допомогою бар’єру, що дозволяє оцінювати мультиклієнтські сценарії.
3. **Безпечність**: у пам'ятному режимі використовується `threading.Lock`, у файловому — блокування файлу через `fcntl`, що усуває `lost update` під час конкурентних записів.

## Приклади серій

- 1 клієнт × 10K запитів → очікуване `count = 10_000`
- 2 клієнти × 10K запитів → очікуване `count = 20_000`
- 5 клієнтів × 10K запитів → очікуване `count = 50_000`
- 10 клієнтів × 10K запитів → очікуване `count = 100_000`

Після кожної серії throughput можна отримати зі стандартного виводу `client.py`, а фінальне значення лічильника — через `GET /count` або з того ж виводу.
